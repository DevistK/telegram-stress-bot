name: Telegram Bot Action

# 파일이 실행 되는 조건
# 현재 기준 main branch 에 코드가 push 되는 조건을 가지고 있음
on:
  push:
    branches: [ "main" ]

jobs:
  cd:
    name : Telegram Bot Action
    # 우분투 컴퓨터 에서 Script 실행
    runs-on : ubuntu-latest
    steps:
      # 코드를 워크플로우로 가져오는 github action
      - name : Checkout Branch
        uses : actions/checkout@v3

      # 도커 로그인
      - name : Docker Login
        uses : docker/login-action@v2.0.0
        with :
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name : Build and Push Docker Images
        uses : docker/build-push-action@v3.0.0
        with :
          content: .
          file : ./Dockerfile
          push : true
          tags : tjehdgur1500/telegram-bot-gcp
          labels: latest

      # GCP 내 인스턴스에 접근하는 github action
      - id : "auth"
        name : Authenticate to GCP
        uses : google-github-actions/auth@v0
        with :
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name : SSH into GCP VM and Deploy
        uses : appleboy/ssh-action@master
        with :
          host : ${{ secrets.GCP_VM_HOST }}
          username : ${{ secrets.GCP_VM_NAME }}
          key : ${{ secrets.GCP_SSH_KEY }}
          port : 80
          scripts : |
            docker stop $(docker ps -a -q)
            docker rm $(docker ps -a -q)
            docker pull tjehdgur1500/telegram-bot-gcp:latest
            docker run -d -p 8000:8000 tjehdgur1500/telegram-bot-gcp:latest