name: telegrambot-action
on:
  push:
    branches: [ "main" ]
jobs:
  cd:
    name : telegrambot-action
    # The type of runner that the job will run on
    runs-on : ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name : Checkout Branch
        uses : actions/checkout@v3

      - name : Set up Node.js
        uses : actions/setup-node@v3
        with :
          node-version: '20.x'

      - name : Install Dependencies
        run : npm install

      - name : Setting ENV.DEV
        run : |
          echo "TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}" >> env.dev

      - name : Build
        run : npm run build

      - name : Start Server
        run : npm run start:dev

      - id : "auth"
        name : Authenticate to GCP
        uses : google-github-actions/auth@v0
        with :
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name : server-on
        run : |-
          gcloud compute ssh --project=${{ secrets.GCP_PROJECT_ID }} --zone=${{ secrets.GCP_ZONE }} ${{ secrets.GCP_VM_NAME }}@${{ secrets.GCP_VM_NAME2 }} -- \
          "cd github-action && \
          docker-compose stop && \
          docker system prune -a && \
          git pull &&
          docker-compose -f docker-compose.prod.yaml build && \
          docker-compose -f docker-compose.prod.yaml up -d
          "
