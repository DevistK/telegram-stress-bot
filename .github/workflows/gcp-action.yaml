name: Telegram Bot Action

# 파일이 실행 되는 조건
# 현재 기준 main branch 에 코드가 push 되는 조건을 가지고 있음
on:
  push:
    branches: [ "main" ]

jobs:
  cd:
    name : Telegram Bot Action
    # 우분투 컴퓨터 에서 Script 실행
    runs-on : ubuntu-latest
    steps:
      # 코드를 워크플로우로 가져오는 github action
      - name : Checkout Branch
        uses : actions/checkout@v3

      # 도커 로그인
      - name : Docker Login
        uses : docker/login-action@v2.0.0
        with :
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name : Build and Push Docker Images
        uses : docker/build-push-action@v3.0.0
        with :
          content: .
          file : ./Dockerfile
          push : true
          tags : telegram-bot/server
          labels: latest

      # GCP 내 인스턴스에 접근하는 github action
      - id : "auth"
        name : Authenticate to GCP
        uses : google-github-actions/auth@v0
        with :
          credentials_json: ${{ secrets.GCP_SA_KEY }}

#      - name : Latest Github Code Pull
#        run : |-
#          gcloud compute ssh --project=${{ secrets.GCP_PROJECT_ID }} --zone=${{ secrets.GCP_ZONE }} ${{ secrets.GCP_VM_NAME }}@${{ secrets.GCP_VM_NAME2 }} -- \
#          "cd ow-stress-relief && \
#          git config --global credential.helper 'store --file=.git-credentials' && \
#          echo 'https://DevistK:${{ secrets.GIT_ACCESS_TOKEN }}@github.com/' > .git-credentials && \
#          git checkout main && \
#          git pull"
#
#      - name : Set up Node.js
#        uses : actions/setup-node@v3
#        with :
#          node-version: '20.x'
#
#      - name : Install Dependencies
#        run : npm install
#
#      - name : Setting ENV.DEV
#        run : |
#          echo "TELEGRAM_API_KEY=${{ secrets.TELEGRAM_API_KEY }}" >> env.dev
#
#      - name : Build
#        run : npm run build
#
#      - name : Start Server
#        run : nohup sudo npm run start:dev > server.log 2>&1 &
